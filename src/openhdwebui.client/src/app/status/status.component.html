<section class="status-page">
  <div class="status-hero">
    <div class="status-chip-group">
      <div class="status-chip"
           [class.ok]="status?.hasData && !status?.hasError"
           [class.error]="status?.hasError">
        <span class="dot"></span>
        {{ statusBadge }}
      </div>
      <div class="mode-chip"
           [class.disabled]="!runMode?.isAvailable"
           (click)="toggleModeMenu()">
        <span class="mode-label">{{ runMode?.isAvailable ? (runMode?.mode || 'unknown') : 'mode unavailable' }}</span>
        <span class="mode-chevron">▾</span>
        <div class="mode-menu" *ngIf="showModeMenu && runMode?.isAvailable">
          <button type="button"
                  class="mode-option"
                  *ngIf="runMode?.mode === 'air'"
                  (click)="setRunMode('ground')">
            Set Ground
          </button>
          <button type="button"
                  class="mode-option"
                  *ngIf="runMode?.mode === 'ground'"
                  (click)="setRunMode('air')">
            Set Air
          </button>
        </div>
      </div>
    </div>

    <h1>OpenHD Status</h1>
    <p class="lead">{{ statusTitle }}</p>
  </div>

  <div class="status-grid">
    <article class="status-card"
             [class.ok]="status?.hasData && !status?.hasError"
             [class.error]="status?.hasError">
      <div class="card-header">
        <div class="icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 3v4m0 10v4M4.9 4.9l2.8 2.8m8.6 8.6 2.8 2.8M3 12h4m10 0h4M4.9 19.1l2.8-2.8m8.6-8.6 2.8-2.8"
                  fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="12" cy="12" r="3.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </div>
        <div>
          <h2>System State</h2>
          <p class="muted">{{ statusSummary }}</p>
        </div>
      </div>

      <div class="status-rows">
        <div class="status-row">
          <span class="label">State</span>
          <span class="value">{{ status?.state || 'Waiting for update' }}</span>
        </div>
        <div class="status-row">
          <span class="label">Description</span>
          <span class="value">{{ status?.description || '—' }}</span>
        </div>
        <div class="status-row">
          <span class="label">Message</span>
          <span class="value">{{ status?.message || '—' }}</span>
        </div>
        <div class="status-row">
          <span class="label">Severity</span>
          <span class="value">{{ status?.hasData ? status?.severity : '—' }}</span>
        </div>
        <div class="status-row">
          <span class="label">Last update</span>
          <span class="value">{{ formatTimestamp(status?.updatedMs) }}</span>
        </div>
      </div>

      <div class="partition-progress" *ngIf="isPartitioning">
        <div class="progress-label">Partitioning in progress</div>
        <div class="progress-track" role="progressbar" aria-label="Partitioning progress">
          <span class="progress-fill"></span>
        </div>
      </div>
    </article>

    <article class="status-card secondary">
      <div class="card-header">
        <div class="icon soft">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 7h14M5 12h14M5 17h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h2>Connection</h2>
          <p class="muted">WebUI connects to openhd_sys_utils over the Unix socket.</p>
        </div>
      </div>

      <div class="status-rows">
        <div class="status-row">
          <span class="label">Socket</span>
          <span class="value">{{ status?.isAvailable ? 'Connected' : 'Unavailable' }}</span>
        </div>
        <div class="status-row">
          <span class="label">Redirect</span>
          <span class="value">Status stays available from any tab.</span>
        </div>
      </div>
      <div class="status-error" *ngIf="status?.hasError">
        <h3>OpenHD errors detected</h3>
        <p class="muted">Review the latest status values and check logs in the Debug tab.</p>
      </div>

      <div class="status-history" *ngIf="errorHistory.length">
        <h3>Recent errors</h3>
        <div class="history-row" *ngFor="let entry of errorHistory">
          <div>
            <div class="history-title">
              {{ entry.description || entry.message || entry.state || 'Unknown error' }}
            </div>
            <div class="history-meta">
              Severity {{ entry.severity }} · {{ formatTimestamp(entry.updatedMs) }}
            </div>
          </div>
          <div class="history-state">{{ entry.state || '—' }}</div>
        </div>
      </div>
    </article>


    <article class="status-card storage">
      <div class="card-header">
        <div class="icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <rect x="3.5" y="4" width="17" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
            <rect x="3.5" y="14" width="17" height="6" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
            <circle cx="7" cy="7" r="0.9" fill="currentColor"/>
            <circle cx="7" cy="17" r="0.9" fill="currentColor"/>
          </svg>
        </div>
        <div>
          <h2>Storage</h2>
          <p class="muted">Review partitions and free space before resizing.</p>
        </div>
      </div>

      <div class="resize-prompt" *ngIf="showResizePrompt; else noResize">
        <div class="prompt-title">{{ resizableLabel() }}</div>
        <p class="muted">Only the last FAT32 partition next to free space can be expanded.</p>
        <div class="prompt-actions">
          <button type="button"
                  class="prompt-button"
                  [class.active]="resizeChoice === 'yes'"
                  (click)="setResizeChoice('yes')">Yes</button>
          <button type="button"
                  class="prompt-button"
                  [class.active]="resizeChoice === 'no'"
                  (click)="setResizeChoice('no')">No</button>
        </div>
        <div class="prompt-status">{{ resizeChoiceLabel }}</div>
        <p class="error-text" *ngIf="resizeError">{{ resizeError }}</p>
      </div>

      <ng-template #noResize>
        <div class="resize-summary">
          <div class="resize-summary-card">
            <div class="prompt-title">Recordings free space</div>
            <p class="muted">{{ recordingsFreeLabel }}</p>
          </div>
          <div class="resize-summary-card" *ngIf="partitionReport?.recordings">
            <div class="prompt-title">Recordings</div>
            <div class="file-list" *ngIf="partitionReport?.recordings?.files?.length; else noRecordings">
              <div class="file-row" *ngFor="let file of partitionReport?.recordings?.files">{{ file }}</div>
            </div>
            <ng-template #noRecordings>
              <p class="muted">No recordings saved.</p>
            </ng-template>
          </div>
        </div>
      </ng-template>

      <p class="error-text" *ngIf="partitionError">{{ partitionError }}</p>

      <ng-container *ngIf="showResizePrompt && partitionReport?.disks?.length; else noDisks">
        <div class="disk-block" *ngFor="let disk of partitionReport?.disks">
          <div class="disk-header">
            <span class="disk-name">{{ disk.name }}</span>
            <span class="disk-size">{{ formatBytes(disk.sizeBytes) }}</span>
          </div>
          <div class="disk-bar">
            <div class="segment"
                 *ngFor="let segment of disk.segments"
                 [class.free]="segment.kind === 'free'"
                 [ngStyle]="segmentStyle(segment, disk)"
                 [style.width.%]="segmentPercent(segment, disk)">
            </div>
          </div>
          <div class="partition-list">
            <div class="partition-row"
                 *ngFor="let part of disk.partitions"
                 [style.--partition-color]="partitionColor(part.device, disk)">
              <div class="partition-name">
                <span class="partition-swatch"
                      [style.backgroundColor]="partitionColor(part.device, disk)"></span>
                <span class="partition-label">
                  {{ partitionTypeLabel(part) }}
                  <span class="partition-sub" *ngIf="partitionLabel(part)">{{ partitionLabel(part) }}</span>
                </span>
              </div>
              <div class="partition-size">
                {{ formatBytes(part.sizeBytes) }}
                <span class="partition-size-sub"
                      *ngIf="isRecordings(part) && part.freeBytes">
                  {{ formatBytes(part.freeBytes) }} free
                </span>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #noDisks>
        <p class="muted" *ngIf="showResizePrompt">No partitions detected yet.</p>
      </ng-template>
    </article>
  </div>

  <div class="status-footer">
    <p *ngIf="lastError" class="error-text">{{ lastError }}</p>
  </div>
</section>
