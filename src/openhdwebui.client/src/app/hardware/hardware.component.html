<section class="hardware-page">
  <div class="hardware-hero">
    <div class="chip" [class.offline]="!platform?.isAvailable">
      <span class="dot"></span>
      {{ platform?.isAvailable ? 'SYSUTILS ONLINE' : 'SYSUTILS OFFLINE' }}
    </div>
    <h1>Hardware Detection</h1>
    <p class="lead">Platform and Wi-Fi detection are served by openhd_sys_utils. Use this page to refresh or override detection.</p>
  </div>

  <div class="hardware-grid">
    <article class="card">
      <div class="card-header">
        <div class="icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h2>Platform Detection</h2>
          <p class="muted">Current platform identification cached by sysutils.</p>
        </div>
      </div>

      <div class="info-grid" *ngIf="platform?.isAvailable; else platformUnavailable">
        <div class="info-row">
          <span class="label">Platform Type</span>
          <span class="value">{{ platform?.platformType }}</span>
        </div>
        <div class="info-row">
          <span class="label">Platform Name</span>
          <span class="value">{{ platform?.platformName }}</span>
        </div>
        <div class="info-row">
          <span class="label">Last Action</span>
          <span class="value">{{ platform?.action || 'detect' }}</span>
        </div>
      </div>

      <ng-template #platformUnavailable>
        <p class="muted">Sysutils socket not reachable.</p>
      </ng-template>

      <div class="actions">
        <button class="btn" (click)="refreshPlatform()" [disabled]="loadingPlatform">Refresh Detection</button>
      </div>
    </article>

    <article class="card">
      <div class="card-header">
        <div class="icon soft">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M3 9c3-4 15-4 18 0M6 12c2.5-2.5 9.5-2.5 12 0M9 15c1.2-1.2 4.8-1.2 6 0M12 18h0"
                  fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h2>Wi-Fi Detection</h2>
          <p class="muted">Cards, drivers, vendor/device IDs and overrides.</p>
        </div>
      </div>

      <div class="actions">
        <button class="btn" (click)="refreshWifi()" [disabled]="loadingWifi">Refresh Wi-Fi Scan</button>
      </div>

      <div class="wifi-summary" *ngIf="wifi?.isAvailable; else wifiUnavailable">
        <span>{{ wifi?.cards?.length || 0 }} card(s) detected</span>
        <span class="muted">Action: {{ wifi?.action || 'detect' }}</span>
      </div>

      <ng-template #wifiUnavailable>
        <p class="muted">Sysutils socket not reachable.</p>
      </ng-template>
    </article>

    <article class="card">
      <div class="card-header">
        <div class="icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6 7h12M4 12h16M7 17h10" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h2>Hotspot Settings</h2>
          <p class="muted">Current hotspot strings and mode used by OpenHD.</p>
        </div>
      </div>

      <div class="hotspot-form" *ngIf="hotspot?.isAvailable && hotspot as hotspotData; else hotspotUnavailable">
        <label class="form-field">
          <span>Hotspot mode</span>
          <select [(ngModel)]="hotspotData.hotspotMode" [disabled]="loadingHotspot">
            <option *ngFor="let option of hotspotModeOptions" [ngValue]="option.value">
              {{ option.label }}
            </option>
          </select>
        </label>
        <label class="form-field">
          <span>SSID</span>
          <input type="text" [(ngModel)]="hotspotData.hotspotSsid" [disabled]="loadingHotspot">
        </label>
        <label class="form-field">
          <span>Password</span>
          <input type="password" [(ngModel)]="hotspotData.hotspotPassword" [disabled]="loadingHotspot">
        </label>
        <label class="form-field">
          <span>Interface</span>
          <input type="text" [(ngModel)]="hotspotData.hotspotInterfaceOverride" [disabled]="loadingHotspot">
        </label>
        <div class="hint-row">
          <span>Last action: {{ hotspot?.action || 'load' }}</span>
        </div>
      </div>

      <ng-template #hotspotUnavailable>
        <p class="muted">OpenHD settings directory not reachable.</p>
      </ng-template>

      <div class="actions">
        <button class="btn" (click)="refreshHotspot()" [disabled]="loadingHotspot || !hotspot?.isAvailable">Refresh</button>
        <button class="btn subtle" (click)="clearHotspotOverrides()" [disabled]="loadingHotspot || !hotspot?.isAvailable">Reset overrides</button>
        <button class="btn primary" (click)="saveHotspot()" [disabled]="loadingHotspot || !hotspot?.isAvailable">Save settings</button>
      </div>
    </article>
  </div>

  <article class="card config-card">
    <div class="card-header">
      <div class="icon soft">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 3v3m0 12v3M3 12h3m12 0h3M6 6l2 2m8 8 2 2M6 18l2-2m8-8 2-2"
                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h2>Hardware Configuration</h2>
        <p class="muted">Settings supplied by sysutils (formerly hardware.config).</p>
      </div>
    </div>

    <div class="config-body" *ngIf="hardwareConfig?.isAvailable && hardwareConfig as configData; else hardwareConfigUnavailable">
      <div class="config-section">
        <h3>Wi-Fi</h3>
        <div class="config-grid">
          <label class="form-field">
            <span>Autodetect</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.wifiEnableAutodetect" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
          <label class="form-field">
            <span>WB link cards</span>
            <input type="text" [(ngModel)]="configData.wifiWbLinkCards" [disabled]="loadingHardwareConfig"
                   placeholder="wlan1,wlan2">
          </label>
          <label class="form-field">
            <span>Hotspot card</span>
            <input type="text" [(ngModel)]="configData.wifiHotspotCard" [disabled]="loadingHardwareConfig"
                   placeholder="wlan0">
          </label>
          <label class="form-field">
            <span>Monitor emulation</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.wifiMonitorCardEmulate" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
          <label class="form-field">
            <span>Force hotspot only</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.wifiForceNoLinkButHotspot" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
          <label class="form-field">
            <span>Local network</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.wifiLocalNetworkEnable" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
          <label class="form-field">
            <span>Local SSID</span>
            <input type="text" [(ngModel)]="configData.wifiLocalNetworkSsid" [disabled]="loadingHardwareConfig">
          </label>
          <label class="form-field">
            <span>Local password</span>
            <input type="password" [(ngModel)]="configData.wifiLocalNetworkPassword" [disabled]="loadingHardwareConfig">
          </label>
        </div>
      </div>

      <div class="config-section">
        <h3>Networking</h3>
        <div class="config-grid">
          <label class="form-field">
            <span>Ethernet card</span>
            <input type="text" [(ngModel)]="configData.nwEthernetCard" [disabled]="loadingHardwareConfig">
          </label>
          <label class="form-field">
            <span>Manual forwarding IPs</span>
            <input type="text" [(ngModel)]="configData.nwManualForwardingIps" [disabled]="loadingHardwareConfig"
                   placeholder="192.168.1.10,192.168.1.11">
            <div class="field-warning" *ngIf="isInvalidIpList(configData.nwManualForwardingIps)">
              Invalid IP list. Use comma-separated IPv4 addresses.
            </div>
          </label>
          <label class="form-field">
            <span>Forward to localhost 58xx</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.nwForwardToLocalhost58xx" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
        </div>
      </div>

      <div class="config-section">
        <h3>Generic</h3>
        <div class="config-grid">
          <label class="form-field">
            <span>Store last known position</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.genEnableLastKnownPosition" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
          <label class="form-field">
            <span>RF metrics level</span>
            <input type="number" [(ngModel)]="configData.genRfMetricsLevel" [disabled]="loadingHardwareConfig" min="0">
          </label>
        </div>
      </div>

      <div class="config-section">
        <h3>Ethernet Link</h3>
        <div class="config-grid">
          <label class="form-field">
            <span>Ground unit IP</span>
            <input type="text" [(ngModel)]="configData.groundUnitIp" [disabled]="loadingHardwareConfig">
            <div class="field-warning" *ngIf="isInvalidIp(configData.groundUnitIp)">
              Invalid IPv4 address.
            </div>
          </label>
          <label class="form-field">
            <span>Air unit IP</span>
            <input type="text" [(ngModel)]="configData.airUnitIp" [disabled]="loadingHardwareConfig">
            <div class="field-warning" *ngIf="isInvalidIp(configData.airUnitIp)">
              Invalid IPv4 address.
            </div>
          </label>
          <label class="form-field">
            <span>Video port</span>
            <input type="number" [(ngModel)]="configData.videoPort" [disabled]="loadingHardwareConfig" min="0">
            <div class="field-warning" *ngIf="isInvalidPort(configData.videoPort)">
              Port must be between 1 and 65535.
            </div>
          </label>
          <label class="form-field">
            <span>Telemetry port</span>
            <input type="number" [(ngModel)]="configData.telemetryPort" [disabled]="loadingHardwareConfig" min="0">
            <div class="field-warning" *ngIf="isInvalidPort(configData.telemetryPort)">
              Port must be between 1 and 65535.
            </div>
          </label>
        </div>
      </div>

      <div class="config-section">
        <h3>Microhard</h3>
        <div class="config-grid">
          <label class="form-field">
            <span>Disable detection</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.disableMicrohardDetection" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
          <label class="form-field">
            <span>Force microhard</span>
            <div class="toggle-row">
              <input type="checkbox" [(ngModel)]="configData.forceMicrohard" [disabled]="loadingHardwareConfig">
              <span>Enabled</span>
            </div>
          </label>
          <label class="form-field">
            <span>Username</span>
            <input type="text" [(ngModel)]="configData.microhardUsername" [disabled]="loadingHardwareConfig">
          </label>
          <label class="form-field">
            <span>Password</span>
            <input type="password" [(ngModel)]="configData.microhardPassword" [disabled]="loadingHardwareConfig">
          </label>
          <label class="form-field">
            <span>IP Air</span>
            <input type="text" [(ngModel)]="configData.microhardIpAir" [disabled]="loadingHardwareConfig">
            <div class="field-warning" *ngIf="isInvalidIp(configData.microhardIpAir)">
              Invalid IPv4 address.
            </div>
          </label>
          <label class="form-field">
            <span>IP Ground</span>
            <input type="text" [(ngModel)]="configData.microhardIpGround" [disabled]="loadingHardwareConfig">
            <div class="field-warning" *ngIf="isInvalidIp(configData.microhardIpGround)">
              Invalid IPv4 address.
            </div>
          </label>
          <label class="form-field">
            <span>IP Range</span>
            <input type="text" [(ngModel)]="configData.microhardIpRange" [disabled]="loadingHardwareConfig">
            <div class="field-warning" *ngIf="isInvalidIpRange(configData.microhardIpRange)">
              Invalid range. Use a 1-3 octet IPv4 prefix (e.g. 192.168.168).
            </div>
          </label>
          <label class="form-field">
            <span>Video port</span>
            <input type="number" [(ngModel)]="configData.microhardVideoPort" [disabled]="loadingHardwareConfig" min="0">
            <div class="field-warning" *ngIf="isInvalidPort(configData.microhardVideoPort)">
              Port must be between 1 and 65535.
            </div>
          </label>
          <label class="form-field">
            <span>Telemetry port</span>
            <input type="number" [(ngModel)]="configData.microhardTelemetryPort" [disabled]="loadingHardwareConfig" min="0">
            <div class="field-warning" *ngIf="isInvalidPort(configData.microhardTelemetryPort)">
              Port must be between 1 and 65535.
            </div>
          </label>
        </div>
      </div>
    </div>

    <ng-template #hardwareConfigUnavailable>
      <p class="muted">Sysutils socket not reachable.</p>
    </ng-template>

    <p class="muted" *ngIf="hardwareConfigError">{{ hardwareConfigError }}</p>

    <div class="actions">
      <button class="btn" (click)="refreshHardwareConfig()" [disabled]="loadingHardwareConfig">Refresh</button>
      <button class="btn subtle" (click)="resetHardwareConfigToDefaults()" [disabled]="loadingHardwareConfig || !hardwareConfig?.isAvailable">Reset to defaults</button>
      <button class="btn primary" (click)="saveHardwareConfig()"
              [disabled]="loadingHardwareConfig || !hardwareConfig?.isAvailable || hardwareConfigHasErrors()">Save settings</button>
    </div>

    <div class="restart-banner" *ngIf="showRestartPrompt">
      <div>
        <div class="restart-title">Restart required</div>
        <div class="muted">Restart OpenHD to apply hardware configuration changes.</div>
      </div>
      <button class="btn primary"
              *ngIf="restartCommand"
              (click)="runRestartCommand()"
              [disabled]="restartRunning">
        Restart OpenHD
      </button>
      <div class="muted" *ngIf="!restartCommand">Use the System page to restart OpenHD.</div>
    </div>
  </article>

  <div class="table-wrap" *ngIf="wifi?.isAvailable">
    <table class="wifi-table">
      <thead>
        <tr>
          <th>Interface</th>
          <th>Driver</th>
          <th>Vendor</th>
          <th>Device</th>
          <th>PHY</th>
          <th>MAC</th>
          <th>Detected</th>
          <th>Power Level</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let card of wifi?.cards" [class.disabled]="card.disabled">
          <td>{{ card.interfaceName }}</td>
          <td>{{ card.driverName || '-' }}</td>
          <td>{{ card.vendorId || '-' }}</td>
          <td>{{ card.deviceId || '-' }}</td>
          <td>{{ card.phyIndex }}</td>
          <td>{{ card.mac || '-' }}</td>
          <td>{{ card.detectedType || 'UNKNOWN' }}</td>
          <td>
            <div class="power-cell">
              <div>
                <div class="power-level">{{ card.powerLevel || 'Auto' }}</div>
                <div class="muted" *ngIf="card.txPower">{{ card.txPower }} mW</div>
              </div>
              <button class="btn subtle small" (click)="openTxPowerModal(card)" [disabled]="loadingWifi">
                Edit
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="modal-backdrop" *ngIf="txPowerModalOpen" (click)="closeTxPowerModal()">
    <div class="modal-card" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h3>TX Power Settings</h3>
          <p class="muted">Interface: {{ selectedWifiCard?.interfaceName || '-' }}</p>
        </div>
        <button class="btn subtle small" (click)="closeTxPowerModal()" [disabled]="txPowerSaving || loadingWifi">
          Close
        </button>
      </div>
      <div class="modal-body">
        <div class="profile-form" *ngIf="wifiProfiles as profileData; else profilesUnavailable">
          <label class="form-field">
            <span>Card profile</span>
            <select [(ngModel)]="selectedProfileKey" (ngModelChange)="selectProfile($event)" [disabled]="loadingWifiProfiles">
              <option *ngFor="let profile of profileData.cards" [ngValue]="buildProfileKey(profile.vendorId, profile.deviceId)">
                {{ profile.name || 'Unnamed' }} ({{ profile.vendorId }} / {{ profile.deviceId }})
              </option>
            </select>
          </label>
          <div class="profile-meta" *ngIf="selectedProfileKey">
            <div>
              <span class="label">Vendor / Device</span>
              <span class="value">{{ wifiProfileForm.vendorId }} / {{ wifiProfileForm.deviceId }}</span>
            </div>
            <div>
              <span class="label">Profile name</span>
              <span class="value">{{ wifiProfileForm.name || 'Unnamed' }}</span>
            </div>
          </div>
          <label class="form-field">
            <span>TX power mode</span>
            <ng-container *ngIf="!isFixedProfile(); else fixedMode">
              <div class="radio-group">
                <label>
                  <input type="radio" [(ngModel)]="wifiProfileForm.powerMode" value="mw" [disabled]="loadingWifiProfiles">
                  Power in mW
                </label>
                <label>
                  <input type="radio" [(ngModel)]="wifiProfileForm.powerMode" value="powerindex" [disabled]="loadingWifiProfiles">
                  TX power index
                </label>
              </div>
            </ng-container>
            <ng-template #fixedMode>
              <div class="muted">Fixed (not editable)</div>
            </ng-template>
          </label>
          <ng-container *ngIf="!isFixedProfile(); else fixedLevels">
            <label class="form-field">
              <span>Lowest power</span>
              <input type="text" inputmode="numeric" [(ngModel)]="wifiProfileForm.lowest"
                     [disabled]="loadingWifiProfiles" placeholder="e.g. 25">
            </label>
            <label class="form-field">
              <span>Low power</span>
              <input type="text" inputmode="numeric" [(ngModel)]="wifiProfileForm.low"
                     [disabled]="loadingWifiProfiles" placeholder="e.g. 100">
            </label>
            <label class="form-field">
              <span>Mid power</span>
              <input type="text" inputmode="numeric" [(ngModel)]="wifiProfileForm.mid"
                     [disabled]="loadingWifiProfiles" placeholder="e.g. 200">
            </label>
            <label class="form-field">
              <span>High power</span>
              <input type="text" inputmode="numeric" [(ngModel)]="wifiProfileForm.high"
                     [disabled]="loadingWifiProfiles" placeholder="e.g. 500">
            </label>
          </ng-container>
          <ng-template #fixedLevels>
            <div class="muted">Fixed power (no editable levels).</div>
          </ng-template>
        </div>
        <ng-template #profilesUnavailable>
          <p class="muted">Profile list not available.</p>
        </ng-template>
        <p class="muted" *ngIf="txPowerError">{{ txPowerError }}</p>
      </div>
      <div class="actions modal-actions">
        <button class="btn subtle" (click)="closeTxPowerModal()" [disabled]="txPowerSaving || loadingWifi">Cancel</button>
        <button class="btn primary" (click)="saveTxPower()" [disabled]="txPowerSaving || loadingWifi || !canSaveTxPower()">Save</button>
      </div>
    </div>
  </div>
</section>
